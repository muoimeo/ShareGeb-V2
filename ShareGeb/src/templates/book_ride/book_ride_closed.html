{% extends "base.html" %}

{% block extra_css %}
<link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
<style>
    body {
        background-color: #f8f9fa;
        overflow-x: hidden;
        position: relative;
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
    }
    
    /* CSS để làm mờ navbar */
    .navbar {
        background-color: rgba(253, 86, 2, 0.8) !important;
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
    }
    
    .map-fullscreen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        z-index: 1;
    }
    
    #map {
        width: 100%;
        height: 100%;
    }
    
    .search-container {
        position: absolute;
        top: 80px;
        left: 50%;
        transform: translateX(-50%);
        width: 90%;
        max-width: 600px;
        z-index: 10;
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 5px 25px rgba(0,0,0,0.15);
        padding: 20px;
        animation: slide-down 0.5s ease-out;
        transition: opacity 0.3s ease;
    }
    
    .search-container.faded {
        opacity: 0.6;
        pointer-events: auto; /* Luôn cho phép tương tác */
    }
    
    .search-container.faded.clickable {
        opacity: 0.8; /* Tăng độ rõ khi ở chế độ có thể nhấp */
        pointer-events: auto;
    }
    
    @keyframes slide-down {
        from {
            opacity: 0;
            transform: translate(-50%, -20px);
        }
        to {
            opacity: 1;
            transform: translate(-50%, 0);
        }
    }
    
    .search-input {
        width: 100%;
        padding: 15px 20px;
        border: none;
        border-radius: 8px;
        background-color: #f1f3f5;
        font-size: 1.1rem;
        transition: all 0.3s ease;
    }
    
    .search-input:focus {
        background-color: #e9ecef;
        outline: none;
        box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.2);
    }
    
    .search-buttons {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }
    
    .btn-search {
        flex: 1;
        padding: 12px 15px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .btn-primary {
        background-color: #0066CC;
        color: white;
    }
    
    .btn-primary:hover {
        background-color: #0055aa;
    }
    
    .btn-outline {
        background-color: transparent;
        border: 2px solid #0066CC;
        color: #0066CC;
    }
    
    .btn-outline:hover {
        background-color: rgba(0, 102, 204, 0.1);
    }
    
    .ride-details {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        width: 66%;
        margin: 0 auto;
        background-color: white;
        border-radius: 20px 20px 0 0;
        box-shadow: 0 -5px 25px rgba(0,0,0,0.1);
        z-index: 10;
        padding: 25px;
        transform: translateY(80%);
        transition: transform 0.5s ease;
        max-height: 80vh;
        overflow-y: auto;
    }
    
    .ride-details.active {
        transform: translateY(0);
    }
    
    .ride-details.partial {
        transform: translateY(50%);
    }
    
    .ride-details .handle {
        width: 60px;
        height: 5px;
        background-color: #ddd;
        border-radius: 5px;
        margin: 0 auto 20px;
        cursor: grab;
        position: relative;
        user-select: none;
    }
    
    .ride-details .handle::before {
        content: '';
        position: absolute;
        top: -20px;
        left: -200px;
        right: -200px;
        bottom: 20px;
        cursor: grab;
    }
    
    /* Ngăn chọn văn bản khi kéo */
    .dragging {
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        cursor: grabbing;
    }
    
    .ride-info {
        display: flex;
        justify-content: space-between;
        margin-bottom: 30px;
    }
    
    .info-item {
        text-align: center;
        flex: 1;
    }
    
    .info-item i {
        font-size: 1.5rem;
        color: #0066CC;
        margin-bottom: 10px;
    }
    
    .btn-book {
        width: 100%;
        padding: 15px;
        font-size: 1.1rem;
        font-weight: 700;
        border: none;
        border-radius: 12px;
        background-color: #0066CC;
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .btn-book:hover {
        background-color: #0055aa;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 102, 204, 0.3);
    }
    
    .suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border-radius: 0 0 12px 12px;
        max-height: 300px;
        overflow-y: auto;
        z-index: 100;
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        display: none;
    }
    
    .suggestion-item {
        padding: 12px 20px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
        transition: background-color 0.2s ease;
    }
    
    .suggestion-item:hover {
        background-color: #f8f9fa;
    }
    
    .suggestion-item .main-text {
        font-weight: 600;
        color: #333;
    }
    
    .suggestion-item .sub-text {
        font-size: 0.9em;
        color: #666;
    }
    
    .suggestion-item .category-tag {
        display: inline-block;
        font-size: 0.75em;
        background: #eee;
        color: #666;
        padding: 2px 6px;
        border-radius: 3px;
        margin-left: 5px;
    }
    
    .loading-text {
        text-align: center;
        padding: 10px;
        color: #666;
    }
    
    .location-dot {
        position: fixed;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background-color: #0066CC;
        border: 3px solid white;
        box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        z-index: 5;
        pointer-events: none;
        display: block;
    }
    
    .location-dot::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: rgba(0, 102, 204, 0.3);
        animation: pulse 2s infinite;
    }
    
    .payment-methods-container {
        max-height: 300px;
        overflow-y: auto;
    }
    
    .payment-method {
        display: flex;
        align-items: center;
        padding: 12px 15px;
        border-radius: 10px;
        background-color: #f8f9fa;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .payment-method:hover {
        background-color: #e9ecef;
    }
    
    .payment-method.selected {
        background-color: #e6f7ff;
        border: 1px solid #0066CC;
    }
    
    .payment-icon {
        font-size: 1.5rem;
        color: #0066CC;
        width: 40px;
        text-align: center;
        margin-right: 15px;
    }
    
    .payment-info {
        flex-grow: 1;
    }
    
    .payment-title {
        font-weight: 600;
        margin-bottom: 2px;
    }
    
    .payment-subtitle {
        font-size: 0.8rem;
        color: #6c757d;
    }
    
    .payment-check {
        color: #0066CC;
        visibility: hidden;
    }
    
    .payment-method.selected .payment-check {
        visibility: visible;
    }

    /* Đảm bảo các ô input luôn có thể tương tác */
    .search-container input {
        z-index: 20;
        position: relative;
    }
</style>
{% endblock %}

{% block content %}
<div class="map-fullscreen">
    <div id="map"></div>
    <div class="location-dot" id="locationDot"></div>
</div>

<div class="search-container">
    <div style="position: relative; margin-bottom: 15px;">
        <input type="text" class="search-input" id="pickupInput" placeholder="Điểm đón">
        <div id="pickupSuggestions" class="suggestions"></div>
    </div>
    <div style="position: relative;">
        <input type="text" class="search-input" id="destinationInput" placeholder="Điểm đến">
        <div id="suggestions" class="suggestions"></div>
    </div>
    <div class="search-buttons">
        <button class="btn-search btn-outline" id="btnLocateMe">
            <i class="fas fa-location-arrow me-2"></i>Vị trí của tôi
        </button>
        <button class="btn-search btn-primary" id="btnConfirm">
            <i class="fas fa-check me-2"></i>Xác nhận
        </button>
    </div>
</div>

<div class="ride-details" id="rideDetails">
    <div class="handle"></div>
    
    <div class="ride-info">
        <div class="info-item">
            <i class="fas fa-clock"></i>
            <div class="label">Thời gian</div>
            <div class="value" id="estimatedTime">-- phút</div>
        </div>
        <div class="info-item">
            <i class="fas fa-route"></i>
            <div class="label">Quãng đường</div>
            <div class="value" id="estimatedDistance">-- km</div>
        </div>
        <div class="info-item">
            <i class="fas fa-money-bill-wave"></i>
            <div class="label">Giá dự kiến</div>
            <div class="value" id="estimatedPrice">-- ₫</div>
        </div>
    </div>
    
    <div class="pickup-time">
        <h3 class="section-title">Thời gian đón</h3>
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="pickupNow" checked>
                <label class="form-check-label" for="pickupNow">Đặt xe ngay</label>
            </div>
            <div id="pickupTimeContainer" class="d-none">
                <input type="time" class="form-control" id="pickupTime">
            </div>
        </div>
    </div>
    
    <div class="payment-methods">
        <h3 class="section-title">Phương thức thanh toán</h3>
        
        <div class="payment-methods-container">
            <!-- Phương thức thanh toán mặc định: Tiền mặt -->
            <div class="payment-method payment-method-item selected" data-payment-type="cash">
                <div class="payment-icon">
                    <i class="fas fa-money-bill-wave"></i>
                </div>
                <div class="payment-info">
                    <div class="payment-title">Tiền mặt</div>
                    <div class="payment-subtitle">Thanh toán bằng tiền mặt khi hoàn thành chuyến đi</div>
                </div>
                <div class="payment-check">
                    <i class="fas fa-check-circle"></i>
                </div>
            </div>
            
            <!-- Thẻ tín dụng -->
            {% if credit_cards %}
                {% for card in credit_cards %}
                <div class="payment-method payment-method-item" data-payment-type="credit_card" data-id="{{ card.card_id }}">
                    <div class="payment-icon">
                        <i class="fas fa-credit-card"></i>
                    </div>
                    <div class="payment-info">
                        <div class="payment-title">{{ card.card_type }} **** {{ card.card_number[-4:] }}</div>
                        <div class="payment-subtitle">Thẻ tín dụng/ghi nợ</div>
                    </div>
                    <div class="payment-check">
                        <i class="fas fa-check-circle"></i>
                    </div>
                </div>
                {% endfor %}
            {% endif %}
            
            <!-- Ví điện tử -->
            {% if wallets %}
                {% for wallet in wallets %}
                <div class="payment-method payment-method-item" data-payment-type="wallet" data-id="{{ wallet.wallet_id }}">
                    <div class="payment-icon">
                        <i class="fas fa-wallet"></i>
                    </div>
                    <div class="payment-info">
                        <div class="payment-title">{{ wallet.wallet_type }}</div>
                        <div class="payment-subtitle">Ví điện tử</div>
                    </div>
                    <div class="payment-check">
                        <i class="fas fa-check-circle"></i>
                    </div>
                </div>
                {% endfor %}
            {% endif %}
            
            <div class="mt-3">
                <a href="{{ url_for('payment.add_payment_method', payment_type='credit', from_booking='1') }}" class="text-decoration-none">
                    <i class="fas fa-plus-circle me-2"></i>Thêm phương thức thanh toán mới
                </a>
            </div>
        </div>
    </div>
    
    <button class="btn-book" id="btnBookRide">
        <i class="fas fa-car me-2"></i>Đặt xe riêng
    </button>
</div>
{% endblock %}

{% block scripts %}
<script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Khởi tạo Mapbox token
        mapboxgl.accessToken = 'pk.eyJ1IjoibXVvaW1lbyIsImEiOiJjbTh5Y3FtNzAwYXd4MmpxeDVrcGViMHY1In0.4B_fLJjaZU0KY9pA2TlbKA';
        
        // Biến lưu trữ
        let map;
        let markers = [];
        let userLocation;
        let selectedPickupCoords;
        let selectedDestination;
        let sessionToken = generateRandomToken();
        let directionsData = null;
        let pickupMarker = null;
        let destinationMarker = null;
        let useCurrentLocationAsPickup = true;
        let selectedPaymentMethod = 'cash';
        let selectedPaymentId = null;
        
        // Default coordinates (Hanoi)
        const DEFAULT_CENTER = [105.8542, 21.0285];
        const DEFAULT_BOUNDS = [
            [102.14441, 8.18314], // [West, South]
            [109.46464, 23.39291]  // [East, North]
        ];
        
        // Initialize map
        map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v12',
            center: DEFAULT_CENTER, 
            zoom: 14,
            maxBounds: DEFAULT_BOUNDS
        });
        
        // Thêm controls
        map.addControl(new mapboxgl.NavigationControl());

        // Tạo token ngẫu nhiên
        function generateRandomToken() {
            return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        }
        
        // Khởi tạo map
        map.on('load', function() {
            // Thêm nguồn dữ liệu cho tuyến đường
            map.addSource('route', {
                type: 'geojson',
                data: {
                    type: 'Feature',
                    properties: {},
                    geometry: {
                        type: 'LineString',
                        coordinates: []
                    }
                }
            });
            
            map.addLayer({
                id: 'route',
                type: 'line',
                source: 'route',
                layout: {
                    'line-join': 'round',
                    'line-cap': 'round'
                },
                paint: {
                    'line-color': '#0066CC',
                    'line-width': 6,
                    'line-opacity': 0.8
                }
            });
            
            // Lấy vị trí người dùng khi tải trang
            locateUser();
        });
        
        // Hiển thị điểm định vị ở giữa màn hình
        map.on('move', function() {
            const dot = document.getElementById('locationDot');
            if (dot) {
                // Lấy tọa độ pixel của vị trí người dùng trên bản đồ
                if (userLocation) {
                    const point = map.project(userLocation);
                    dot.style.left = point.x + 'px';
                    dot.style.top = point.y + 'px';
                }
            }
        });
        
        // Định vị người dùng
        function locateUser() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        userLocation = [position.coords.longitude, position.coords.latitude];
                        
                        // Nếu đang sử dụng vị trí hiện tại làm điểm đón, cập nhật biến selectedPickupCoords
                        if (useCurrentLocationAsPickup) {
                            selectedPickupCoords = userLocation;
                            document.getElementById('pickupInput').value = "Vị trí hiện tại của bạn";
                        }
                        
                        // Xóa marker cũ
                        if (pickupMarker) pickupMarker.remove();
                        
                        // Tạo marker mới
                        pickupMarker = new mapboxgl.Marker({ color: '#3498db' })
                            .setLngLat(userLocation)
                            .setPopup(new mapboxgl.Popup().setHTML("<strong>Vị trí của bạn</strong>"))
                            .addTo(map);
                        
                        // Di chuyển map
                        map.flyTo({
                            center: userLocation,
                            zoom: 15,
                            essential: true
                        });
                        
                        // Cập nhật vị trí của locationDot
                        const dot = document.getElementById('locationDot');
                        if (dot) {
                            const point = map.project(userLocation);
                            dot.style.left = point.x + 'px';
                            dot.style.top = point.y + 'px';
                        }
                        
                        // Tính toán tuyến đường nếu cả điểm đón và điểm đến đã được chọn
                        if (selectedPickupCoords && selectedDestination) {
                            getDirections(selectedPickupCoords, selectedDestination);
                        }
                    },
                    function(error) {
                        console.error('Lỗi định vị:', error);
                        alert('Không thể xác định vị trí của bạn. Vui lòng kiểm tra quyền truy cập vị trí.');
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            } else {
                alert('Trình duyệt của bạn không hỗ trợ định vị.');
            }
        }
        
        // Tìm kiếm với gợi ý cho điểm đến
        async function searchDestinationWithSuggestions(searchText) {
            if (!searchText || searchText.length < 2) {
                document.getElementById('suggestions').style.display = 'none';
                return;
            }
            
            try {
                document.getElementById('suggestions').innerHTML = '<div class="loading-text">Đang tìm kiếm...</div>';
                document.getElementById('suggestions').style.display = 'block';
                
                const response = await fetch(
                    `https://api.mapbox.com/search/searchbox/v1/suggest?` +
                    `q=${encodeURIComponent(searchText)}` +
                    `&language=vi` +
                    `&country=vn` +
                    `&bbox=${DEFAULT_BOUNDS[0].join(',')}%2C${DEFAULT_BOUNDS[1].join(',')}` +
                    `&access_token=${mapboxgl.accessToken}` +
                    `&session_token=${sessionToken}`
                );
                
                if (!response.ok) {
                    throw new Error(`Lỗi API Mapbox: ${response.status}`);
                }
                
                const data = await response.json();
                const suggestionsDiv = document.getElementById('suggestions');
                suggestionsDiv.innerHTML = '';
                
                if (data.suggestions && data.suggestions.length > 0) {
                    data.suggestions.forEach(suggestion => {
                        const name = suggestion.name || '';
                        const address = suggestion.full_address || suggestion.place_formatted || '';
                        const category = suggestion.category && suggestion.category.primary ? suggestion.category.primary : '';
                        
                        const div = document.createElement('div');
                        div.className = 'suggestion-item';
                        div.innerHTML = `
                            <div class="main-text">
                                ${name}
                                ${category ? `<span class="category-tag">${category}</span>` : ''}
                            </div>
                            <div class="sub-text">${address}</div>
                        `;
                        
                        div.onclick = async () => {
                            await retrieveAndSelectDestination(suggestion.mapbox_id);
                            suggestionsDiv.style.display = 'none';
                        };
                        
                        suggestionsDiv.appendChild(div);
                    });
                } else {
                    suggestionsDiv.innerHTML = '<div class="suggestion-item">Không tìm thấy kết quả</div>';
                }
            } catch (error) {
                console.error('Lỗi tìm kiếm địa điểm:', error);
                document.getElementById('suggestions').innerHTML = '<div class="suggestion-item">Đã có lỗi xảy ra. Vui lòng thử lại sau.</div>';
            }
        }
        
        // Tìm kiếm với gợi ý cho điểm đón
        async function searchPickupWithSuggestions(searchText) {
            if (!searchText || searchText.length < 2) {
                document.getElementById('pickupSuggestions').style.display = 'none';
                return;
            }
            
            try {
                document.getElementById('pickupSuggestions').innerHTML = '<div class="loading-text">Đang tìm kiếm...</div>';
                document.getElementById('pickupSuggestions').style.display = 'block';
                
                const response = await fetch(
                    `https://api.mapbox.com/search/searchbox/v1/suggest?` +
                    `q=${encodeURIComponent(searchText)}` +
                    `&language=vi` +
                    `&country=vn` +
                    `&bbox=${DEFAULT_BOUNDS[0].join(',')}%2C${DEFAULT_BOUNDS[1].join(',')}` +
                    `&access_token=${mapboxgl.accessToken}` +
                    `&session_token=${sessionToken}`
                );
                
                if (!response.ok) {
                    throw new Error(`Lỗi API Mapbox: ${response.status}`);
                }
                
                const data = await response.json();
                const suggestionsDiv = document.getElementById('pickupSuggestions');
                suggestionsDiv.innerHTML = '';
                
                if (data.suggestions && data.suggestions.length > 0) {
                    data.suggestions.forEach(suggestion => {
                        const name = suggestion.name || '';
                        const address = suggestion.full_address || suggestion.place_formatted || '';
                        const category = suggestion.category && suggestion.category.primary ? suggestion.category.primary : '';
                        
                        const div = document.createElement('div');
                        div.className = 'suggestion-item';
                        div.innerHTML = `
                            <div class="main-text">
                                ${name}
                                ${category ? `<span class="category-tag">${category}</span>` : ''}
                            </div>
                            <div class="sub-text">${address}</div>
                        `;
                        
                        div.onclick = async () => {
                            await retrieveAndSelectPickup(suggestion.mapbox_id);
                            suggestionsDiv.style.display = 'none';
                            useCurrentLocationAsPickup = false;
                        };
                        
                        suggestionsDiv.appendChild(div);
                    });
                } else {
                    suggestionsDiv.innerHTML = '<div class="suggestion-item">Không tìm thấy kết quả</div>';
                }
            } catch (error) {
                console.error('Lỗi tìm kiếm địa điểm:', error);
                document.getElementById('pickupSuggestions').innerHTML = '<div class="suggestion-item">Đã có lỗi xảy ra. Vui lòng thử lại sau.</div>';
            }
        }
        
        // Lấy chi tiết và chọn điểm đến
        async function retrieveAndSelectDestination(mapboxId) {
            try {
                const response = await fetch(
                    `https://api.mapbox.com/search/searchbox/v1/retrieve/${mapboxId}?` +
                    `access_token=${mapboxgl.accessToken}` +
                    `&session_token=${sessionToken}`
                );
                
                const data = await response.json();
                if (!data.features || data.features.length === 0) {
                    console.error('Không tìm thấy thông tin địa điểm');
                    return;
                }
                
                const feature = data.features[0];
                const coordinates = feature.geometry.coordinates;
                const name = feature.properties.name || '';
                const fullAddress = feature.properties.full_address || feature.properties.place_formatted || '';
                const displayText = `${name}, ${fullAddress}`.trim();
                
                // Cập nhật input
                document.getElementById('destinationInput').value = displayText;
                
                // Lưu tọa độ đã chọn
                selectedDestination = coordinates;
                
                // Xóa marker cũ nếu có
                if (destinationMarker) destinationMarker.remove();
                
                // Thêm marker mới
                destinationMarker = new mapboxgl.Marker({ color: '#FF0000' })
                    .setLngLat(coordinates)
                    .setPopup(new mapboxgl.Popup().setHTML("<strong>Điểm đến</strong>"))
                    .addTo(map);
                
                // Di chuyển map đến điểm đến
                map.flyTo({
                    center: coordinates,
                    zoom: 15,
                    essential: true
                });
                
                // Tính toán tuyến đường nếu đã có điểm xuất phát
                if (selectedPickupCoords) {
                    getDirections(selectedPickupCoords, selectedDestination);
                }
                
                // Tạo token mới sau khi chọn địa điểm
                setTimeout(() => {
                    sessionToken = generateRandomToken();
                }, 1000);
            } catch (error) {
                console.error('Lỗi lấy thông tin địa điểm:', error);
                alert('Không thể lấy thông tin chi tiết của địa điểm. Vui lòng thử lại sau.');
            }
        }

        // Lấy chi tiết và chọn điểm đón
        async function retrieveAndSelectPickup(mapboxId) {
            try {
                const response = await fetch(
                    `https://api.mapbox.com/search/searchbox/v1/retrieve/${mapboxId}?` +
                    `access_token=${mapboxgl.accessToken}` +
                    `&session_token=${sessionToken}`
                );
                
                const data = await response.json();
                if (!data.features || data.features.length === 0) {
                    console.error('Không tìm thấy thông tin địa điểm');
                    return;
                }
                
                const feature = data.features[0];
                const coordinates = feature.geometry.coordinates;
                const name = feature.properties.name || '';
                const fullAddress = feature.properties.full_address || feature.properties.place_formatted || '';
                const displayText = `${name}, ${fullAddress}`.trim();
                
                // Cập nhật input
                document.getElementById('pickupInput').value = displayText;
                
                // Lưu tọa độ đã chọn
                selectedPickupCoords = coordinates;
                
                // Xóa marker cũ nếu có
                if (pickupMarker) pickupMarker.remove();
                
                // Thêm marker mới
                pickupMarker = new mapboxgl.Marker({ color: '#3498db' })
                    .setLngLat(coordinates)
                    .setPopup(new mapboxgl.Popup().setHTML("<strong>Điểm đón</strong>"))
                    .addTo(map);
                
                // Di chuyển map đến điểm đón
                map.flyTo({
                    center: coordinates,
                    zoom: 15,
                    essential: true
                });
                
                // Tính toán tuyến đường nếu đã có điểm đến
                if (selectedDestination) {
                    getDirections(selectedPickupCoords, selectedDestination);
                }
                
                // Tạo token mới sau khi chọn địa điểm
                setTimeout(() => {
                    sessionToken = generateRandomToken();
                }, 1000);
            } catch (error) {
                console.error('Lỗi lấy thông tin địa điểm:', error);
                alert('Không thể lấy thông tin chi tiết của địa điểm. Vui lòng thử lại sau.');
            }
        }
        
        // Tính toán tuyến đường
        async function getDirections(origin, destination) {
            try {
                const response = await fetch(
                    `https://api.mapbox.com/directions/v5/mapbox/driving/` +
                    `${origin[0]},${origin[1]};` +
                    `${destination[0]},${destination[1]}?` +
                    `steps=true&` +
                    `geometries=geojson&` +
                    `overview=full&` +
                    `language=vi&` +
                    `access_token=${mapboxgl.accessToken}`
                );
                
                if (!response.ok) {
                    throw new Error(`Lỗi API Directions: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.routes && data.routes.length > 0) {
                    directionsData = data.routes[0];
                    
                    // Hiển thị tuyến đường trên bản đồ
                    map.getSource('route').setData({
                        type: 'Feature',
                        properties: {},
                        geometry: directionsData.geometry
                    });
                    
                    // Hiển thị thông tin tuyến đường
                    const distance = directionsData.distance / 1000; // km
                    const duration = Math.round(directionsData.duration / 60); // phút
                    const price = Math.round(distance * 20000); // 20k VND/km (đắt hơn xe ghép)
                    
                    document.getElementById('estimatedDistance').textContent = distance.toFixed(1) + ' km';
                    document.getElementById('estimatedTime').textContent = duration + ' phút';
                    document.getElementById('estimatedPrice').textContent = price.toLocaleString('vi-VN') + ' ₫';
                } else {
                    alert('Không tìm thấy tuyến đường phù hợp.');
                }
            } catch (error) {
                console.error('Lỗi tính toán tuyến đường:', error);
                alert('Có lỗi xảy ra khi tính toán tuyến đường. Vui lòng thử lại sau.');
            }
        }
        
        // Event listeners
        
        // Xử lý input tìm kiếm
        const debounce = (func, delay) => {
            let timeoutId;
            return function(...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => func.apply(this, args), delay);
            };
        };

        const debouncedDestinationSearch = debounce(searchDestinationWithSuggestions, 300);
        const debouncedPickupSearch = debounce(searchPickupWithSuggestions, 300);
        
        document.getElementById('destinationInput').addEventListener('input', function(e) {
            debouncedDestinationSearch(e.target.value);
        });
        
        document.getElementById('pickupInput').addEventListener('input', function(e) {
            // Nếu người dùng đang nhập địa chỉ mới, không sử dụng vị trí hiện tại
            if (e.target.value.trim() !== "Vị trí hiện tại của bạn") {
                useCurrentLocationAsPickup = false;
            }
            debouncedPickupSearch(e.target.value);
        });

        // Nút định vị
        document.getElementById('btnLocateMe').addEventListener('click', function() {
            useCurrentLocationAsPickup = true;
            document.getElementById('pickupInput').value = "Vị trí hiện tại của bạn";
            locateUser();
        });

        // Nút xác nhận
        document.getElementById('btnConfirm').addEventListener('click', function() {
            if (!selectedPickupCoords) {
                alert('Vui lòng chọn điểm đón hoặc cho phép định vị vị trí của bạn.');
                return;
            }
            
            if (!selectedDestination) {
                alert('Vui lòng chọn điểm đến.');
                return;
            }
            
            // Đảm bảo chúng ta có dữ liệu hướng đi
            if (directionsData) {
                // Điều chỉnh viewport để hiển thị toàn bộ tuyến đường
                const bounds = new mapboxgl.LngLatBounds();
                directionsData.geometry.coordinates.forEach(coord => {
                    bounds.extend(coord);
                });
                
                map.fitBounds(bounds, {
                    padding: 100,
                    maxZoom: 15
                });
            }
            
            // Hiển thị chi tiết chuyến đi đầy đủ ngay lập tức
            const rideDetails = document.getElementById('rideDetails');
            rideDetails.classList.add('active');
            rideDetails.classList.remove('partial');
            rideDetails.style.transform = 'translateY(0)';
            
            // Làm mờ phần tìm kiếm
            const searchContainer = document.querySelector('.search-container');
            searchContainer.classList.add('faded');
            searchContainer.classList.remove('clickable');
            searchContainer.style.opacity = '0.6';
        });
        
        // Xử lý phương thức thanh toán
        document.querySelectorAll('.payment-method-item').forEach(method => {
            method.addEventListener('click', function() {
                // Bỏ chọn tất cả phương thức thanh toán
                document.querySelectorAll('.payment-method-item').forEach(item => {
                    item.classList.remove('selected');
                });
                
                // Chọn phương thức hiện tại
                this.classList.add('selected');
                
                // Lưu thông tin phương thức thanh toán
                selectedPaymentMethod = this.getAttribute('data-payment-type');
                selectedPaymentId = this.getAttribute('data-id');
            });
        });
        
        // Nút đặt xe
        document.getElementById('btnBookRide').addEventListener('click', function() {
            if (!directionsData) {
                alert('Vui lòng xác nhận điểm đến trước khi đặt xe.');
                return;
            }
            
            // Hiển thị thông báo đặt xe thành công
            const isScheduled = !document.getElementById('pickupNow').checked;
            const scheduledTime = isScheduled ? document.getElementById('pickupTime').value : null;
            
            let message = 'Đặt xe riêng thành công!\n\n';
            message += `Điểm đón: ${document.getElementById('pickupInput').value}\n`;
            message += `Điểm đến: ${document.getElementById('destinationInput').value}\n`;
            message += `Quãng đường: ${document.getElementById('estimatedDistance').textContent}\n`;
            message += `Thời gian dự kiến: ${document.getElementById('estimatedTime').textContent}\n`;
            message += `Giá dự kiến: ${document.getElementById('estimatedPrice').textContent}\n`;
            message += `Phương thức thanh toán: ${selectedPaymentMethod === 'cash' ? 'Tiền mặt' : 
                        selectedPaymentMethod === 'credit_card' ? 'Thẻ tín dụng' : 'Ví điện tử'}\n`;
            message += isScheduled ? `Thời gian đón: ${scheduledTime}` : 'Thời gian đón: Ngay lập tức';
            
            alert(message);
            
            // Chuyển hướng về trang chủ (hoặc trang theo dõi chuyến đi)
            // window.location.href = '/';
        });
        
        // Xử lý nút "Đặt xe ngay"
        document.getElementById('pickupNow').addEventListener('change', function() {
            const timeContainer = document.getElementById('pickupTimeContainer');
            if (this.checked) {
                timeContainer.classList.add('d-none');
            } else {
                timeContainer.classList.remove('d-none');
            }
        });
        
        // Đóng gợi ý khi click bên ngoài
        document.addEventListener('click', function(e) {
            const suggestions = document.getElementById('suggestions');
            const pickupSuggestions = document.getElementById('pickupSuggestions');
            const destinationInput = document.getElementById('destinationInput');
            const pickupInput = document.getElementById('pickupInput');
            
            if (e.target !== destinationInput && !suggestions.contains(e.target)) {
                suggestions.style.display = 'none';
            }
            
            if (e.target !== pickupInput && !pickupSuggestions.contains(e.target)) {
                pickupSuggestions.style.display = 'none';
            }
        });
        
        // Xử lý kéo thả panel thông tin
        const rideDetails = document.getElementById('rideDetails');
        const handle = document.querySelector('.ride-details .handle');
        const searchContainer = document.querySelector('.search-container');
        
        let startY = 0;
        let startTransform = 0;
        let isDragging = false;
        
        handle.addEventListener('mousedown', startDrag);
        handle.addEventListener('touchstart', startDrag);
        
        function startDrag(e) {
            isDragging = true;
            startY = e.type === 'mousedown' ? e.clientY : e.touches[0].clientY;
            startTransform = getCurrentTranslateY(rideDetails);
            
            document.addEventListener('mousemove', drag);
            document.addEventListener('touchmove', drag);
            document.addEventListener('mouseup', endDrag);
            document.addEventListener('touchend', endDrag);
        }
        
        function drag(e) {
            if (!isDragging) return;
            
            const currentY = e.type === 'mousemove' ? e.clientY : e.touches[0].clientY;
            const deltaY = currentY - startY;
            
            let newTranslateY = startTransform + deltaY;
            
            // Giới hạn kéo xuống không quá 80% và kéo lên không quá 0%
            newTranslateY = Math.min(Math.max(newTranslateY, 0), window.innerHeight * 0.8);
            
            rideDetails.style.transform = `translateY(${newTranslateY}px)`;
            
            // Thêm class ngăn chọn văn bản khi kéo
            document.body.classList.add('dragging');
            
            // Điều chỉnh độ trong suốt của searchContainer dựa trên vị trí của rideDetails
            const opacity = Math.min(newTranslateY / (window.innerHeight * 0.5), 1);
            searchContainer.style.opacity = 0.4 + opacity * 0.6;
            
            // Thêm/bỏ class để điều chỉnh có thể click vào searchContainer hay không
            if (opacity > 0.7) {
                searchContainer.classList.add('clickable');
            } else {
                searchContainer.classList.remove('clickable');
            }
        }
        
        function endDrag() {
            if (!isDragging) return;
            
            isDragging = false;
            
            // Xóa class ngăn chọn văn bản
            document.body.classList.remove('dragging');
            
            document.removeEventListener('mousemove', drag);
            document.removeEventListener('touchmove', drag);
            document.removeEventListener('mouseup', endDrag);
            document.removeEventListener('touchend', endDrag);
            
            const currentTranslateY = getCurrentTranslateY(rideDetails);
            
            // Quyết định vị trí cuối cùng dựa trên vị trí hiện tại
            if (currentTranslateY < window.innerHeight * 0.3) {
                // Kéo lên cao: hiển thị đầy đủ
                rideDetails.style.transform = 'translateY(0)';
                rideDetails.classList.add('active');
                rideDetails.classList.remove('partial');
                searchContainer.classList.add('faded');
                searchContainer.classList.remove('clickable');
            } else if (currentTranslateY < window.innerHeight * 0.6) {
                // Kéo ở giữa: hiển thị một nửa
                rideDetails.style.transform = 'translateY(50%)';
                rideDetails.classList.add('partial');
                rideDetails.classList.remove('active');
                searchContainer.classList.add('faded', 'clickable');
            } else {
                // Kéo xuống thấp: ẩn đi
                rideDetails.style.transform = 'translateY(80%)';
                rideDetails.classList.remove('active', 'partial');
                searchContainer.classList.remove('faded', 'clickable');
            }
        }
        
        function getCurrentTranslateY(element) {
            const style = window.getComputedStyle(element);
            const matrix = new WebKitCSSMatrix(style.transform);
            return matrix.m42; // Lấy giá trị translateY
        }
        
        // Thêm sự kiện focus cho các input
        document.getElementById('pickupInput').addEventListener('focus', function() {
            if (searchContainer.classList.contains('faded')) {
                // Khi focus vào input, đưa panel thông tin xuống và làm rõ phần tìm kiếm
                rideDetails.style.transform = 'translateY(80%)';
                rideDetails.classList.remove('active', 'partial');
                searchContainer.classList.remove('faded', 'clickable');
                searchContainer.style.opacity = '1';
            }
        });

        document.getElementById('destinationInput').addEventListener('focus', function() {
            if (searchContainer.classList.contains('faded')) {
                // Khi focus vào input, đưa panel thông tin xuống và làm rõ phần tìm kiếm
                rideDetails.style.transform = 'translateY(80%)';
                rideDetails.classList.remove('active', 'partial');
                searchContainer.classList.remove('faded', 'clickable');
                searchContainer.style.opacity = '1';
            }
        });
    });
</script>
{% endblock %}